<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sankey (Top N) - Excel</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin: 16px; }

    .controls { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; margin-bottom: 12px; }
    .control { display: flex; gap: 8px; align-items: center; }
    .stat { color: #333; font-size: 13px; }

    /* Filtros en 2ª línea */
    .filters-row { display: flex; gap: 16px; width: 100%; flex-wrap: wrap; }

    /* Ventana fija del gráfico (SIN scroll vertical) */
    #chartWrap {
      width: 1800px;
      height: 800px;
      overflow: hidden;         /* <- sin scroll */
      border: 1px solid #e5e5e5;
      border-radius: 10px;
      padding: 8px;
      box-sizing: border-box;
    }

    .hint { color: #666; font-size: 12px; margin-top: 8px; }
    input[type="range"] { width: 260px; }
    .error { color: #b00020; font-size: 13px; white-space: pre-wrap; }

    button {
      border: 1px solid #ddd;
      background: #fff;
      border-radius: 8px;
      padding: 6px 10px;
      cursor: pointer;
    }
    button:hover { background: #f6f6f6; }
  </style>
</head>
<body>
  <h2>Sankey desde Excel (Top N enlaces)</h2>

  <div class="controls">
    <div class="control">
      <label for="file">Excel (.xlsx):</label>
      <input id="file" type="file" accept=".xlsx" />
    </div>

    <div class="control">
      <label for="topN">Top N enlaces:</label>
      <input id="topN" type="range" min="5" max="200" step="5" value="30" />
      <span id="topNVal" class="stat">30</span>
    </div>

    <div class="control">
      <label for="sheetName">Hoja:</label>
      <select id="sheetName" disabled></select>
    </div>

    <div class="control">
      <button id="zoomIn" type="button">+</button>
      <button id="zoomOut" type="button">−</button>
      <button id="zoomReset" type="button">Reset</button>
    </div>

    <div class="stat" id="stats"></div>

    <div class="filters-row">
      <div class="control">
        <label for="originFilter">Salida:</label>
        <select id="originFilter" disabled>
          <option value="">Todas</option>
        </select>
      </div>

      <div class="control">
        <label for="destFilter">Llegada:</label>
        <select id="destFilter" disabled>
          <option value="">Todas</option>
        </select>
      </div>
    </div>
  </div>

  <div id="chartWrap">
    <div class="hint">Carga un Excel para ver el diagrama.</div>
  </div>

  <div id="err" class="error"></div>

  <!-- D3 + d3-sankey -->
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <script src="https://unpkg.com/d3-sankey@0.12/dist/d3-sankey.min.js"></script>
  <!-- SheetJS (XLSX) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <script>
    // --- Estado ---
    let rows = [];
    let workbook = null;
    let currentSheet = null;

    // Zoom state (para mantener zoom entre renders)
    let zoomTransform = d3.zoomIdentity;

    const els = {
      file: document.getElementById("file"),
      topN: document.getElementById("topN"),
      topNVal: document.getElementById("topNVal"),
      sheetName: document.getElementById("sheetName"),
      chartWrap: document.getElementById("chartWrap"),
      stats: document.getElementById("stats"),
      originFilter: document.getElementById("originFilter"),
      destFilter: document.getElementById("destFilter"),
      zoomIn: document.getElementById("zoomIn"),
      zoomOut: document.getElementById("zoomOut"),
      zoomReset: document.getElementById("zoomReset"),
      err: document.getElementById("err")
    };

    function fillSelect(selectEl, values) {
      selectEl.innerHTML = `<option value="">Todas</option>`;
      values.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v;
        opt.textContent = v;
        selectEl.appendChild(opt);
      });
    }

    // --- Config (ventana fija 1800x800) ---
    const WIDTH = 1800;
    const HEIGHT = 800;
    const NODE_WIDTH = 15;
    const NODE_PADDING = 10;

    // Columnas esperadas
    const COL_SOURCE = "UP origen";
    const COL_TARGET = "UP Destí grouped";
    const COL_VALUE  = "Total derivacions";

    const fmt = d3.format(",.0f");
    const color = d3.scaleOrdinal(d3.schemeTableau10);

    function setError(msg) {
      els.err.textContent = msg || "";
    }

    function ensureColumns() {
      if (!rows.length) return "No hay filas en la hoja seleccionada.";
      const cols = Object.keys(rows[0]);
      const missing = [COL_SOURCE, COL_TARGET, COL_VALUE].filter(c => !cols.includes(c));
      if (missing.length) {
        return "Faltan columnas:\n- " + missing.join("\n- ") +
               "\n\nColumnas detectadas:\n- " + cols.join("\n- ");
      }
      return null;
    }

    function clean(v) {
      return (v == null) ? "" : String(v).trim();
    }

    // --- Construcción Sankey ---
    function buildLinks(allRows) {
      const rolled = d3.rollups(
        allRows,
        v => d3.sum(v, d => +d[COL_VALUE] || 0),
        d => clean(d[COL_SOURCE]),
        d => clean(d[COL_TARGET])
      );

      return rolled.flatMap(([source, targets]) =>
        targets
          .map(([target, value]) => ({ source, target, value }))
          .filter(d => d.source && d.target && d.value > 0)
      );
    }

    function buildNodes(links) {
      return Array.from(
        new Set(links.flatMap(d => [d.source, d.target])),
        name => ({ name })
      );
    }

    function render() {
      setError("");

      if (!rows.length) {
        els.chartWrap.innerHTML = `<div class="hint">Carga un Excel para ver el diagrama.</div>`;
        els.stats.textContent = "";
        return;
      }

      const colErr = ensureColumns();
      if (colErr) {
        setError(colErr);
        els.chartWrap.innerHTML = "";
        els.stats.textContent = "";
        return;
      }

      const topN = +els.topN.value;
      els.topNVal.textContent = topN;

      const originSel = els.originFilter.value; // "" = Todas
      const destSel = els.destFilter.value;     // "" = Todas

      const filteredRows = rows.filter(d => {
        const o = clean(d[COL_SOURCE]);
        const t = clean(d[COL_TARGET]);
        if (originSel && o !== originSel) return false;
        if (destSel && t !== destSel) return false;
        return true;
      });

      const links = buildLinks(filteredRows);

      const linksTop = links
        .slice()
        .sort((a, b) => d3.descending(a.value, b.value))
        .slice(0, topN);

      const nodesTop = buildNodes(linksTop);

      // Layout: SIEMPRE dentro de 1800x800 (sin scroll)
      const sankeyLayout = d3.sankey()
        .nodeId(d => d.name)
        .nodeWidth(NODE_WIDTH)
        .nodePadding(NODE_PADDING)
        .extent([[1, 1], [WIDTH - 1, HEIGHT - 1]]);

      const graph = sankeyLayout({
        nodes: nodesTop.map(d => ({...d})),
        links: linksTop.map(d => ({...d}))
      });

      // Stats
      const totalShown = d3.sum(graph.links, d => d.value);
      els.stats.textContent =
        `Enlaces dibujados: ${graph.links.length}/${links.length} · Nodos: ${graph.nodes.length} · Derivaciones dibujadas: ${fmt(totalShown)}`;

      // --- SVG + Zoom ---
      const svg = d3.create("svg")
        .attr("viewBox", [0, 0, WIDTH, HEIGHT])
        .attr("width", WIDTH)
        .attr("height", HEIGHT)
        .style("display", "block")
        .style("cursor", "grab");

      const gZoom = svg.append("g");

      // Links
      gZoom.append("g")
        .attr("fill", "none")
        .attr("stroke-opacity", 0.55)
        .attr("stroke-linecap", "round")
        .selectAll("path")
        .data(graph.links)
        .join("path")
          .attr("d", d3.sankeyLinkHorizontal())
          .attr("stroke", d => color(d.target.name))
          .attr("stroke-width", d => Math.max(1, d.width))
        .append("title")
          .text(d => `${d.source.name} → ${d.target.name}\n${fmt(d.value)} derivacions`);

      // Nodes
      const node = gZoom.append("g")
        .selectAll("rect")
        .data(graph.nodes)
        .join("rect")
          .attr("x", d => d.x0)
          .attr("y", d => d.y0)
          .attr("width", d => d.x1 - d.x0)
          .attr("height", d => Math.max(1, d.y1 - d.y0))
          .attr("fill", d => color(d.name))
          .attr("stroke", "rgba(0,0,0,0.25)");

      node.append("title")
        .text(d => `${d.name}\n${fmt(d.value)} derivacions`);

      // Labels
      gZoom.append("g")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .selectAll("text")
        .data(graph.nodes)
        .join("text")
          .attr("x", d => (d.x0 < WIDTH / 2) ? d.x1 + 6 : d.x0 - 6)
          .attr("y", d => (d.y0 + d.y1) / 2)
          .attr("dy", "0.35em")
          .attr("text-anchor", d => (d.x0 < WIDTH / 2) ? "start" : "end")
          .text(d => d.name);

      // Zoom behavior (wheel + drag)
      const zoom = d3.zoom()
        .scaleExtent([0.5, 8])
        .on("zoom", (event) => {
          zoomTransform = event.transform;
          gZoom.attr("transform", zoomTransform);
        });

      svg.call(zoom);
      svg.call(zoom.transform, zoomTransform);

      svg.on("mousedown", () => svg.style("cursor", "grabbing"));
      svg.on("mouseup", () => svg.style("cursor", "grab"));
      svg.on("mouseleave", () => svg.style("cursor", "grab"));

      // Botones zoom
      els.zoomIn.onclick = () =>
        svg.transition().duration(200).call(zoom.scaleBy, 1.2);

      els.zoomOut.onclick = () =>
        svg.transition().duration(200).call(zoom.scaleBy, 1 / 1.2);

      els.zoomReset.onclick = () => {
        zoomTransform = d3.zoomIdentity;
        svg.transition().duration(250).call(zoom.transform, zoomTransform);
      };

      // Render sin scroll
      els.chartWrap.innerHTML = "";
      els.chartWrap.style.width = WIDTH + "px";
      els.chartWrap.style.height = HEIGHT + "px";
      els.chartWrap.style.overflow = "hidden";
      els.chartWrap.appendChild(svg.node());
    }

    // --- Carga Excel ---
    function loadSheet(sheetName) {
      if (!workbook) return;
      currentSheet = sheetName;
      const ws = workbook.Sheets[sheetName];

      rows = XLSX.utils.sheet_to_json(ws, { defval: "" });

      // Opciones únicas para filtros (ordenadas)
      const origins = Array.from(new Set(rows.map(d => clean(d[COL_SOURCE]))))
        .filter(Boolean)
        .sort(d3.ascending);

      const dests = Array.from(new Set(rows.map(d => clean(d[COL_TARGET]))))
        .filter(Boolean)
        .sort(d3.ascending);

      fillSelect(els.originFilter, origins);
      fillSelect(els.destFilter, dests);

      els.originFilter.disabled = false;
      els.destFilter.disabled = false;

      // Resetea filtros al cambiar de hoja
      els.originFilter.value = "";
      els.destFilter.value = "";

      // Reset zoom al cambiar de hoja
      zoomTransform = d3.zoomIdentity;

      render();
    }

    els.file.addEventListener("change", async (e) => {
      setError("");
      const file = e.target.files?.[0];
      if (!file) return;

      try {
        const ab = await file.arrayBuffer();
        workbook = XLSX.read(ab, { type: "array" });

        els.sheetName.innerHTML = "";
        workbook.SheetNames.forEach(name => {
          const opt = document.createElement("option");
          opt.value = name;
          opt.textContent = name;
          els.sheetName.appendChild(opt);
        });

        els.sheetName.disabled = false;
        loadSheet(workbook.SheetNames[0]);
      } catch (err) {
        setError("Error leyendo el Excel:\n" + (err?.message || String(err)));
      }
    });

    els.sheetName.addEventListener("change", (e) => loadSheet(e.target.value));
    els.topN.addEventListener("input", render);
    els.originFilter.addEventListener("change", render);
    els.destFilter.addEventListener("change", render);

    render();
  </script>
</body>
</html>
